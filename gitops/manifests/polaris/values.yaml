metrics:
  # -- Specifies whether metrics for the polaris server should be enabled.
  enabled: true
  # -- Additional tags (dimensional labels) to add to the metrics.
  tags:
    {}

extraEnv:
  - name: AZURE_STORAGE_BUCKET
    value: abfss://iceberg@PLACEHOLDER_STORAGE_ACCOUNT.dfs.core.windows.net/
  - name: AZURE_STORAGE_ACCOUNT_NAME
    valueFrom:
      secretKeyRef:
        name: iceberg-bucket-credentials
        key: AZURE_STORAGE_ACCOUNT_NAME
  - name: AZURE_TENANT_ID
    valueFrom:
      secretKeyRef:
        name: iceberg-bucket-credentials
        key: AZURE_TENANT_ID
  - name: AZURE_CLIENT_ID
    valueFrom:
      secretKeyRef:
        name: iceberg-bucket-credentials
        key: AZURE_CLIENT_ID

  - name: POLARIS_PERSISTENCE_TYPE
    value: relational-jdbc

  - name: QUARKUS_DATASOURCE_USERNAME
    valueFrom:
      secretKeyRef:
        name: polaris-postgres-credentials
        key: username

  - name: QUARKUS_DATASOURCE_PASSWORD
    valueFrom:
      secretKeyRef:
        name: polaris-postgres-credentials
        key: password

  - name: POSTGRES_HOST
    valueFrom:
      secretKeyRef:
        name: polaris-postgres-credentials
        key: db-address

  - name: QUARKUS_DATASOURCE_JDBC_URL
    value: "jdbc:postgresql://$(POSTGRES_HOST):5432/database?user=$(QUARKUS_DATASOURCE_USERNAME)&password=$(QUARKUS_DATASOURCE_PASSWORD)"

realmContext:
  realms:
    - database

features:
  DROP_WITH_PURGE_ENABLED: true
  
extraInitContainers:
  - name: polaris-boostrap
    image: apache/polaris-admin-tool:latest
    imagePullPolicy: Always
    env:
      - name: POLARIS_ROOT_PASSWORD
        valueFrom:
          secretKeyRef:
            name: polaris-root-password
            key:  polaris-root-password

      - name: POLARIS_PERSISTENCE_TYPE
        value: relational-jdbc

      - name: POSTGRES_HOST
        valueFrom:
          secretKeyRef:
            name: polaris-postgres-credentials
            key: db-address

      - name: QUARKUS_DATASOURCE_USERNAME
        valueFrom:
          secretKeyRef:
            name: polaris-postgres-credentials
            key: username

      - name: QUARKUS_DATASOURCE_PASSWORD
        valueFrom:
          secretKeyRef:
            name: polaris-postgres-credentials
            key: password

      - name: QUARKUS_DATASOURCE_JDBC_URL
        value: "jdbc:postgresql://$(POSTGRES_HOST):5432/database?user=$(QUARKUS_DATASOURCE_USERNAME)&password=$(QUARKUS_DATASOURCE_PASSWORD)"
    
    command:
      - "/bin/bash"
      - "-c"
      - |
        set -x
        ACCEPTABLE_ERROR="already been bootstrapped"
        
        # Execute the command, redirecting stderr to stdout to capture all output
        OUTPUT=$(java -jar /deployments/polaris-admin-tool.jar bootstrap --realm=database --credential=database,root,${POLARIS_ROOT_PASSWORD} 2>&1)
        EXIT_CODE=$?
        
        echo "--- Polaris Bootstrap Output ---"
        echo "${OUTPUT}"
        echo "------------------------------"
        
        if [ ${EXIT_CODE} -eq 0 ]; then
          echo "Bootstrap successful on the first run."
          exit 0
        fi
        
        if [[ "${OUTPUT}" == *"${ACCEPTABLE_ERROR}"* ]]; then
          echo "Ignoring acceptable error: Metastore is already bootstrapped."
          exit 0
        else
          echo "Bootstrap failed with an unexpected error (Exit Code: ${EXIT_CODE})." >&2
          exit 1
        fi