apiVersion: batch/v1
kind: Job
metadata:
  name: airflow-db-migrate
  namespace: openmetadata
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 10
  template:
    spec:
      restartPolicy: OnFailure
      initContainers:
        - name: wait-for-mysql
          image: busybox:latest
          command: ["sh", "-c", "until nc -z mysql.openmetadata.svc.cluster.local 3306; do echo waiting for mysql; sleep 5; done"]
      containers:
        - name: migrate
          image: docker.getcollate.io/openmetadata/ingestion:1.12.1
          command: ["bash", "-c", "pip install apache-airflow-providers-fab==2.4.4 && airflow db migrate"]
          env:
            - name: AIRFLOW__DATABASE__SQL_ALCHEMY_CONN
              valueFrom:
                secretKeyRef:
                  name: openmetadata-dependencies-metadata
                  key: connection
            - name: AIRFLOW__CORE__AUTH_MANAGER
              value: "airflow.providers.fab.auth_manager.fab_auth_manager.FabAuthManager"
            - name: _PIP_ADDITIONAL_REQUIREMENTS
              value: "apache-airflow-providers-fab==2.4.4"
          volumeMounts:
            - name: config
              mountPath: /opt/airflow/airflow.cfg
              subPath: airflow.cfg
              readOnly: true
      volumes:
        - name: config
          configMap:
            name: openmetadata-dependencies-config
