apiVersion: batch/v1
kind: Job
metadata:
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
    config-hash: 2af23a99d868abd8
  labels:
    app: schema-check
    target: customer-transactions
  name: schema-check-customer-transactions
  namespace: kafka-connect
spec:
  backoffLimit: 3
  template:
    spec:
      containers:
      - command:
        - sh
        - -c
        - |-
          #!/bin/sh
          set -e

          SCHEMA_REGISTRY_URL="http://warpstream-schema-registry-warpstream-agent.warpstream.svc.cluster.local:9094"
          SUBJECT="silver.m3.customer_transactions-value"
          TIMEOUT=300
          INTERVAL=5

          echo "Checking schema subject: $SUBJECT"
          echo "Schema Registry: $SCHEMA_REGISTRY_URL"
          echo "Timeout: ${TIMEOUT}s, Retry interval: ${INTERVAL}s"

          elapsed=0
          while [ $elapsed -lt $TIMEOUT ]; do
              response=$(curl -s -o /dev/null -w "%{http_code}" \
                  -u "$SCHEMA_REGISTRY_USERNAME:$SCHEMA_REGISTRY_PASSWORD" \
                  "$SCHEMA_REGISTRY_URL/subjects/$SUBJECT/versions/latest")

              if [ "$response" = "200" ]; then
                  echo "Schema found for subject: $SUBJECT"
                  schema_info=$(curl -s \
                      -u "$SCHEMA_REGISTRY_USERNAME:$SCHEMA_REGISTRY_PASSWORD" \
                      "$SCHEMA_REGISTRY_URL/subjects/$SUBJECT/versions/latest")
                  echo "Schema info: $schema_info"
                  exit 0
              fi

              echo "Schema not found (HTTP $response), retrying in ${INTERVAL}s... ($elapsed/${TIMEOUT}s)"
              sleep $INTERVAL
              elapsed=$((elapsed + INTERVAL))
          done

          echo "Timeout waiting for schema subject: $SUBJECT"
          exit 1
        env:
        - name: SCHEMA_REGISTRY_USERNAME
          valueFrom:
            secretKeyRef:
              key: username
              name: schema-registry-credentials
        - name: SCHEMA_REGISTRY_PASSWORD
          valueFrom:
            secretKeyRef:
              key: password
              name: schema-registry-credentials
        image: curlimages/curl:8.5.0
        name: schema-check
      restartPolicy: Never
  ttlSecondsAfterFinished: 300
