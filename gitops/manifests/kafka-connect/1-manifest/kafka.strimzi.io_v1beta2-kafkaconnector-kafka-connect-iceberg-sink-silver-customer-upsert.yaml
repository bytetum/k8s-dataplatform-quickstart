apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnector
metadata:
  labels:
    strimzi.io/cluster: m3-kafka-connect
  name: iceberg-sink-silver-customer-upsert
  namespace: kafka-connect
spec:
  class: io.tabular.iceberg.connect.IcebergSinkConnector
  tasksMax: 4
  config:
    # ========================================================================
    # SOURCE TOPICS (Regex Pattern for Customer Data)
    # ========================================================================
    topics.regex: "silver\\.m3\\.(customer_summary|customer_orders)"
    
    # ========================================================================
    # ICEBERG TABLE SETTINGS (Upsert Mode)
    # ========================================================================
    iceberg.tables.auto-create-enabled: true
    iceberg.tables.upsert-mode-enabled: true
    iceberg.tables.evolve-schema-enabled: true
    iceberg.tables.schema-force-optional: true
    iceberg.tables.default-id-columns: "record_key"
    
    # ========================================================================
    # ICEBERG CATALOG (Polaris REST)
    # ========================================================================
    iceberg.catalog: iceberg
    iceberg.catalog.type: rest
    iceberg.catalog.catalog-name: ao_catalog
    iceberg.catalog.uri: http://polaris.polaris.svc.cluster.local:8181/api/catalog
    iceberg.catalog.credential: root:${env:POLARIS_PASSWORD}
    iceberg.catalog.warehouse: ao_catalog
    iceberg.catalog.scope: PRINCIPAL_ROLE:ALL
    iceberg.catalog.oauth2-server-uri: http://polaris.polaris.svc.cluster.local:8181/api/catalog/v1/oauth/tokens
    
    # ========================================================================
    # SCHEMA REGISTRY & SERIALIZATION
    # ========================================================================
    key.converter: io.confluent.connect.avro.AvroConverter
    key.converter.schema.registry.url: http://warpstream-schema-registry-warpstream-agent.warpstream.svc.cluster.local:9094
    key.converter.schema.registry.basic.auth.credentials.source: USER_INFO
    key.converter.schema.registry.basic.auth.user.info: ccun_291350ada8541780bdbc5663f2d22855a4da5bf905a576bac6c8dfa95c89db71:ccp_956975877bc5eeb62ce21d18c49d320a3d128cb9d0c81278999a742f6272090e
    key.converter.schemas.enable: true
    
    value.converter: io.confluent.connect.avro.AvroConverter
    value.converter.schema.registry.url: http://warpstream-schema-registry-warpstream-agent.warpstream.svc.cluster.local:9094
    value.converter.schema.registry.basic.auth.credentials.source: USER_INFO
    value.converter.schema.registry.basic.auth.user.info: ccun_291350ada8541780bdbc5663f2d22855a4da5bf905a576bac6c8dfa95c89db71:ccp_956975877bc5eeb62ce21d18c49d320a3d128cb9d0c81278999a742f6272090e
    value.converter.schemas.enable: true
    
    # ========================================================================
    # TOPIC-TO-TABLE NAME TRANSFORMATION (RegexRouter SMT)
    # ========================================================================
    # Transforms: silver.m3.customer_summary → customer_summary
    #             silver.m3.customer_orders → customer_orders
    transforms: route
    transforms.route.type: org.apache.kafka.connect.transforms.RegexRouter
    transforms.route.regex: "silver\\.m3\\.(.*)"
    transforms.route.replacement: "$1"
    
    # ========================================================================
    # COMMIT COORDINATION & PERFORMANCE
    # ========================================================================
    iceberg.control.commit.interval-ms: 60000
    iceberg.control.commit.threads: 2
    iceberg.control.commit.timeout-ms: 30000
    iceberg.control.topic: sink-control-iceberg-silver-customer-upsert
    iceberg.control.group-id-prefix: m3-iceberg-silver-customer-upsert-control
    
    # ========================================================================
    # ERROR HANDLING (DLQ)
    # ========================================================================
    errors.tolerance: all
    errors.log.enable: true
    errors.deadletterqueue.topic.name: m3.iceberg.dlq.silver.customer
    errors.deadletterqueue.context.headers.enable: true
